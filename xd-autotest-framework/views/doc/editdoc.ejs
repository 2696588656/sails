<div class="container-fluid">
  <div id="page-wrapper-right" aria-hidden="false" class="right-operation">
  <form id="apidoc_form" action="/InterfaceDoc/saveDoc2db" method="post">
    <div class="row" >
      <div class="col-lg-12">
        <h1 class="page-header" id="api_doc_name" uniqid="<%=api_docs.uniqID%>"><%=api_docs.name%></h1>
        <ol class="breadcrumb">
          <li>
            <i class="fa fa-dashboard"></i>文档描述
            <input name="docdesc" value="<%=api_docs.docDesc%>" />
          </li>
          <li>
            <i class="fa fa-dashboard"></i>测试环境
            <input name="testEnv" value="<%=api_docs.testEnv%>" />
          </li>
          <li>
            <i class="fa fa-dashboard"></i>端口号
            <input name="testEnvPort" value="<%=api_docs.testEnvPort%>" />
          </li>
        </ol>


      </div>
    </div>

    <div class="row" >
      <div class="col-lg-6">
          <input name="apis_count" type="hidden" value="<%=api_docs.APIdoc_items.length%>" />
          <ol id="APIs">
            <li id="api_template" uniqid="" style="display: none">
              <i class="fa fa-edit" id="apiTitle" >接口</i>
              <div class="form-group">
                <label>接口名</label>
                <input name="api_title" class="form-control"/>
              </div>
              <div class="form-group">
                <label>接口请求URL</label>
                <input name="api_url" class="form-control" />
              </div>
              <div class="form-group">
                <label>接口请求方式method</label>
                <!--<input name="api_method" class="form-control"  />-->
                <select class="form-control" name="api_method">
                  <option value="POST" selected="selected">POST</option>
                  <option value="GET">GET</option>
                </select>
              </div>
              <div class="form-group">
                <label>接口是否废弃disabled</label>
                <!--<input name="api_disabled" class="form-control" />-->
                <select class="form-control" name="api_disabled" >
                  <option value="false">false</option>
                  <option value="true">true</option>
                </select>
              </div>
              <div class="form-group">
                <label>开发dev</label>
                <select class="form-control" name="api_dev" >
                  <option value="赵聃">赵聃</option>
                  <option value="李德洪">李德洪</option>
                  <option value="周欢">周欢</option>
                </select>
              </div>
              <div class="form-group">
                <label>接口请求格式content-type</label>
                <!--<input name="api_dataType" class="form-control" />-->
                <select class="form-control" name="api_dataType" >
                  <option value="application/json">application/json</option>
                  <option value="application/x-www-form-urlencoded">application/x-www-form-urlencoded</option>
                  <option value="application/application/octet-stream">application/application/octet-stream</option>
                  <option value="text/html">text/html</option>
                  <option value="text/plain">text/plain</option>
                  <option value="text/xml">text/xml</option>
                  <option value="image/gif">image/gif</option>
                  <option value="image/jpeg">image/jpeg</option>
                  <option value="image/png">image/png</option>
                </select>
              </div>
              <div class="form-group">
                <label>接口请求头header</label>
                <textarea name="api_header" rows="8" class="form-control"  />
              </div>
              <div class="form-group">
                <label>接口请求参数queryParams(以json格式输入)</label>
                <textarea name="api_queryParams" rows="8" class="form-control" />
              </div>
              <div class="form-group">
                <label>接口返回结果response(以json格式输入)</label>
                <textarea name="api_response" rows="8" class="form-control"/>
              </div>
            </li>
            <%for(var i=0;i<api_docs.APIdoc_items.length;i++){%>
            <li id="<%='api_'+(i+1)%>" uniqid="<%=api_docs.APIdoc_items[i].uniqID%>" >
              <i class="fa fa-edit" id="apiTitle" >接口</i>
              <div class="form-group">
                <label>接口名</label>
                <input name="api_title" required="required" class="form-control" id="<%='api_title_'+(i+1)%>"
                       value="<%=api_docs.APIdoc_items[i].name%>" />
              </div>
              <div class="form-group">
                <label>接口请求URL</label>
                <input name="api_url" required="required" class="form-control"  id="<%='api_url_'+(i+1)%>"
                       value="<%=api_docs.APIdoc_items[i].url%>"/>
              </div>
              <div class="form-group">
                <label>接口请求方式method</label>
                <!--<input name="api_method" class="form-control" id="<%='api_method_'+(i+1)%>"-->
                       <!--value="<%=api_docs.APIdoc_items[i].method%>"/>-->
                <select class="form-control" name="api_method" >
                  <option value="<%=api_docs.APIdoc_items[i].method%>"><%=api_docs.APIdoc_items[i].method%></option>
                  <option value="POST" >POST</option>
                  <option value="GET">GET</option>
                </select>
              </div>
              <div class="form-group">
                <label>接口是否废弃disabled</label>
                <!--<input name="api_disabled" class="form-control"  id="<%='api_disabled_'+(i+1)%>"-->
                       <!--value="<%=api_docs.APIdoc_items[i].disabled%>"/>-->
                <select class="form-control" name="api_disabled" >
                  <option value="<%=api_docs.APIdoc_items[i].disabled%>"><%=api_docs.APIdoc_items[i].disabled%></option>
                  <option value="false">false</option>
                  <option value="true">true</option>
                </select>
              </div>
              <div class="form-group">
                <label>开发dev</label>
                <select class="form-control" name="api_dev" >
                  <option value="<%=api_docs.APIdoc_items[i].dev%>"><%=api_docs.APIdoc_items[i].dev?api_docs.APIdoc_items[i].dev:"请选择"%></option>
                  <option value="赵聃">赵聃</option>
                  <option value="李德洪">李德洪</option>
                  <option value="周欢">周欢</option>
                </select>
              </div>
              <div class="form-group">
                <label>接口请求格式content-type</label>
                <!--<input name="api_dataType" class="form-control" id="<%='api_dataType_'+(i+1)%>"-->
                       <!--value="<%=api_docs.APIdoc_items[i].dataType%>"/>-->
                <select class="form-control" name="api_dataType" >
                  <option value="<%=api_docs.APIdoc_items[i].dataType%>" color="red"><%=api_docs.APIdoc_items[i].dataType%></option>
                  <option value="application/json">application/json</option>
                  <option value="application/x-www-form-urlencoded">application/x-www-form-urlencoded</option>
                  <option value="application/application/octet-stream">application/application/octet-stream</option>
                  <option value="text/html">text/html</option>
                  <option value="text/plain">text/plain</option>
                  <option value="text/xml">text/xml</option>
                  <option value="image/gif">image/gif</option>
                  <option value="image/jpeg">image/jpeg</option>
                  <option value="image/png">image/png</option>
                </select>
              </div>
              <div class="form-group">
                <label>接口请求头header</label>
                <textarea name="api_header" rows="8" class="form-control" id="<%='api_header_'+(i+1)%>"><%=JSON.stringify(api_docs.APIdoc_items[i].header,null,"\t")%></textarea>
              </div>
              <div class="form-group">
                <label>接口请求参数queryParams(以json格式输入)</label>
                <textarea name="api_queryParams" rows="8" class="form-control" id="<%='api_queryParams_'+(i+1)%>"><%=JSON.stringify(api_docs.APIdoc_items[i].queryParams,null,"\t")%></textarea>
              </div>
              <div class="form-group">
                <label>接口请求参数response(以json格式输入)</label>
                <textarea name="api_response" rows="8" class="form-control" id="<%='api_response_'+(i+1)%>"><%=JSON.stringify(api_docs.APIdoc_items[i].response,null,"\t")%></textarea>
              </div>
            </li>
            <%}%>
          </ol>
      </div>
    </div>
    <div class="row">
      <div class="col-lg-6">
        <div class="btn btn-info" id="addAPIbutton">增加API接口</div>
        <div class="btn btn-default" id="save_doc_2_db">保存文档</div>
      </div>
    </div>
  </form>
</div>
</div>

<script>
  /**
   * 点击增加API接口的编辑入口。
   * */
  $('#addAPIbutton').click(function(){
    /**
    $('h1#123doc')[0].innerHTML="测试1234";
    console.log($('h1#123doc')[0].innerHTML);
**/
    var testItem=$("li#api_template").clone(true);
    var apis_count=$("ol#APIs").children('li').length;
    console.log('apis_count=%d',apis_count);
    testItem.find('input#api_title').attr("id","api_title"+apis_count);
    testItem.find('input#api_url').attr("id","api_url"+apis_count);
    testItem.find('select#api_method').attr("id","api_method_"+apis_count);
    testItem.find('select#api_disabled').attr("id","api_disabled_"+apis_count);
    testItem.find('select#api_dev').attr("id","api_dev_"+apis_count);
    testItem.find('select#api_dataType').attr("id","api_dataType_"+apis_count);
    testItem.find('input#api_header').attr("id","api_header_"+apis_count);
    testItem.find('input#api_queryParams').attr("id","api_queryParams_"+apis_count);
    testItem.find('input#api_response').attr("id","api_response_"+apis_count);
    testItem.attr('id','api_'+apis_count);
    testItem.attr('style',"display:");
    console.log(testItem);
    //$('ol#APIs').prepend(testItem);
    $('ol#APIs').append(testItem);
    console.log("添加api_item完成咯~");
  });

  /** 保存APIdocitem */
  $('#save_doc_2_db').click(function(){
    /** 构造APIdoc对象*/
    var docName=$('#api_doc_name')[0].innerHTML;
    var docDesc=$('input[name="docdesc"]').val();
    var testEnv=$('input[name="testEnv"]').val();
    var testEnvPort=$('input[name="testEnvPort"]').val();
    var doc_uniqId=$('#api_doc_name').attr("uniqid");

    var APIdoc={name:docName,docDesc:docDesc,testEnv:testEnv,testEnvPort:testEnvPort,uniqID:doc_uniqId};
    console.log(JSON.stringify(APIdoc));

    var apisDOM=$('#APIs').children('li[id!="api_template"]');
    var apiItemsArray=new Array();

    for(var i=0;i<apisDOM.length;i++){
      //$('li#api_1').find('input[name="api_title"]').val();
      var selector='li#api_'+(i+1);
      var apiItem_name=$(selector).find('input[name="api_title"]').val();
      var apiItem_url=$(selector).find('input[name="api_url"]').val();
      var apiItem_disabled=$(selector).find('select[name="api_disabled"] option:selected').text();
      var apiItem_dev=$(selector).find('select[name="api_dev"] option:selected').text();
      var apiItem_method=$(selector).find('select[name="api_method"] option:selected').text();
      var apiItem_dataType=$(selector).find('select[name="api_dataType"] option:selected').text();
      var apiItem_header=$(selector).find('textarea[name="api_header"]').val();
      var apiItem_queryParams=$(selector).find('textarea[name="api_queryParams"]').val();
      var apiItem_response=$(selector).find('textarea[name="api_response"]').val();
      var apiItem_uniqId=$(selector).attr("uniqid");



      var apiItem={
        uniqID:apiItem_uniqId,
        name:apiItem_name,
        url:apiItem_url,
        disabled:apiItem_disabled,
        dev:apiItem_dev,
        method:apiItem_method,
        dataType:apiItem_dataType,
        header:apiItem_header,
        queryParams: apiItem_queryParams,
        response:apiItem_response
      };

      apiItemsArray[i]=apiItem;
    }
    console.log("apiItemsArray:");
    console.log(JSON.stringify(apiItemsArray));

    $.ajax({
      url:'/doc/savedocwithItem',
      method:"post",
      contentType: 'application/x-www-form-urlencoded;charset=utf-8',
      data: {
        apiDoc: APIdoc,
        apiItems:apiItemsArray
      },
      success: function (data) {
        //返回的数据用data.d获取内容
        //alert(data.d);
        alert("保存成功!");
      },
      error:function(data){
        alert("保存失败,错误日志:"+JSON.stringify(data,null,"\t"));
      }
    });

  });

</script>
